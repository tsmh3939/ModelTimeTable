# データ処理の注意点

このドキュメントでは、ModelTimeTableプロジェクトにおけるデータ処理の重要な注意点とルールについて説明します。

## 目次

1. [情報応用科目の判定](#情報応用科目の判定)
2. [CSVデータ処理フロー](#csvデータ処理フロー)
3. [複数担当教員の扱い](#複数担当教員の扱い)
4. [履修区分の表示](#履修区分の表示)
5. [開講区分の重複判定](#開講区分の重複判定)
6. [時間割コードの一意性](#時間割コードの一意性)

---

## 情報応用科目の判定

### 判定ロジック

情報応用科目は、CSVデータ処理時に以下のロジックで自動判定されます：

**場所:** `setup/csv_extractor.py` の `extract_affiliated_majors()` 関数

**ルール:**
1. CSVの「メジャー」列が「その他」である
2. かつ、「開講科目名」に「**情報応用**」という文字列が含まれる

上記の条件を満たす場合、メジャーが「情報応用科目」として設定されます。

```python
if majors_str == 'その他':
    if '情報応用' in course_title:
        records.add((timetable_code, '情報応用科目', course_category))
    else:
        records.add((timetable_code, majors_str, course_category))
```

### 注意事項

- 科目名に「情報応用」が含まれていない場合は、「その他」メジャーとして扱われます
- この判定はCSV抽出時に一度だけ行われます
- データベース投入後は、`affiliated_major`テーブルで管理されます

---

## CSVデータ処理フロー

### 1. CSVファイルの配置

年度CSVファイルは `docs/data/YYYY.csv` の形式で配置します：
- 例: `docs/data/2026.csv`

### 2. データ抽出

`setup/csv_extractor.py` を実行してCSVデータを抽出します：

```bash
python setup/csv_extractor.py docs/data/2026.csv
```

#### 抽出されるデータ

以下のCSVファイルが `docs/extracted/` に生成されます：

| ファイル名 | 内容 | 重複排除キー |
|-----------|------|-------------|
| `course.csv` | 科目情報 | 時間割コード |
| `course_schedule.csv` | 開講曜限 | 時間割コード + 曜日 + 時限 |
| `grade_year.csv` | 学年 | 時間割コード + 学年名 |
| `affiliated_major.csv` | 所属メジャー | 時間割コード + メジャー + 履修区分 |
| `instructor_master.csv` | 教員マスタ | 教員名（自動採番） |
| `classroom_master.csv` | 教室マスタ | 教室名（自動採番） |
| `course_classroom.csv` | 科目教室中間 | 時間割コード + 教室名 |

### 3. データ変換（必要に応じて）

`setup/csv_converter.py` でデータ形式を変換します。

### 4. データベース投入

`setup/insert_csv_data.py` を実行してデータベースにデータを投入します：

```bash
python setup/insert_csv_data.py docs/data/2026.csv
```

---

## 複数担当教員の扱い

### データ構造

科目に複数の担当教員がいる場合：
- `main_instructor_id`: 主担当教員のID
- `has_multiple_instructors`: 複数担当フラグ（0 or 1）

### 表示ロジック

**場所:** `src/views/main.py` の `get_instructor_name()` 関数

```python
def get_instructor_name(course):
    name = course.main_instructor.instructor_name
    if course.has_multiple_instructors == 1:
        name += ' 他'
    return name if course.main_instructor else ''
```

**表示例:**
- 単独担当: `山田 太郎`
- 複数担当: `山田 太郎 他`

---

## 履修区分の表示

### 履修区分の種類

| ID | 名称 | 記号 | 説明 |
|----|------|------|------|
| 1 | 必修 | ★ | 必ず履修が必要 |
| 2 | 選択必修 | ☆ | 選択肢の中から必ず履修 |
| 3 | 選択 | なし | 任意で履修 |
| 4 | 必履修 | ★ | 必ず履修（単位認定なし） |

### 表示ルール

**場所:** `src/templates/result.html`

科目名の前に履修区分の記号を表示：

```jinja2
{% if item['course_category_id'] == 1 or item['course_category_id'] == 4 %}
★
{% elif item['course_category_id'] == 2 %}
☆
{% endif %}{{ item['course_title'] }}
```

### 重要な注意点

履修区分は**メジャーごとに異なる**ため、`course_category_id`は以下のように取得されます：

**場所:** `src/views/main.py` の `get_course_category_id()` 関数

- `major_type`（major1, major2, shared, others, info_app）に応じて適切なメジャーIDを選択
- そのメジャーにおける履修区分IDを取得
- 共有科目の場合は第一メジャーの履修区分を使用

---

## 開講区分の重複判定

### 開講区分の関係

| ID | 名称 | 重複する区分 |
|----|------|-------------|
| 1 | 1Q | 前期 |
| 2 | 2Q | 前期 |
| 3 | 3Q | 後期 |
| 4 | 4Q | 後期 |
| 5 | 前期 | 1Q, 2Q |
| 6 | 後期 | 3Q, 4Q |

### 重複判定ロジック

**場所:** `src/templates/result.html` (JavaScript)

時間割の重複を判定する際、以下のルールを適用：
- 前期科目（ID=5）は 1Q（ID=1）と 2Q（ID=2）と重複
- 後期科目（ID=6）は 3Q（ID=3）と 4Q（ID=4）と重複

```javascript
function offeringCategoriesOverlap(cat1, cat2) {
    if (cat1 === cat2) return true;
    const semester1 = [1, 2, 5];
    const semester2 = [3, 4, 6];
    if (semester1.includes(cat1) && semester1.includes(cat2)) return true;
    if (semester2.includes(cat1) && semester2.includes(cat2)) return true;
    return false;
}
```

---

## 時間割コードの一意性

### ルール

時間割コードは科目を一意に識別するキーです：

- **同じ時間割コードの科目は1つの科目として扱われる**
- 複数のメジャーに所属する場合でも、時間割コードは同一
- 科目情報（科目名、単位数、担当教員など）は時間割コード単位で管理

### データ抽出時の処理

**場所:** `setup/csv_extractor.py` の `extract_courses()` 関数

```python
# 時間割コードで重複を避ける
courses: Dict[str, Tuple[...]] = {}

for row in reader:
    timetable_code = row['時間割コード'].strip()

    # 既に登録済みの時間割コードはスキップ
    if timetable_code in courses:
        continue

    # 最初に出現した行の情報を使用
    courses[timetable_code] = (...)
```

### 注意事項

- 履修区分IDは時間割コードではなく、**所属メジャーテーブル**に属する
- 同じ科目でも、メジャーによって履修区分が異なる場合がある
- `affiliated_major`テーブルで（時間割コード + メジャーID）の組み合わせごとに履修区分を管理

---

## メジャー区分の表示

### メジャー区分の略称

時間割表では、各科目のメジャー区分を略称で表示：

| メジャー | 略称 | 色 |
|---------|------|-----|
| 情報学領域共有科目 | 【共】 | 青 (primary) |
| 第1メジャー科目 | 【Ⅰ】 | 青 (primary) |
| 第2メジャー科目 | 【Ⅱ】 | 緑 (secondary) |
| その他メジャー科目 | 【他】 | グレー (info) |
| 情報応用科目 | 【応】 | オレンジ (warning) |

### 表示位置

科目名の上部に、メジャー区分と開講区分を表示：

```
【Ⅰ】 1Q
★データベース基礎
山田 太郎
```

---

## データベース構造の重要ポイント

### リレーションシップ

```
Course (科目)
├── CourseSchedule (開講曜限) - 1対多
├── GradeYear (学年) - 1対多
├── AffiliatedMajor (所属メジャー) - 1対多
│   └── 履修区分ID を含む
├── CourseClassroom (科目教室) - 1対多
│   └── ClassroomMaster (教室マスタ) - 多対1
└── InstructorMaster (教員マスタ) - 多対1
```

### 重要な設計上の注意

1. **履修区分は科目単位ではなく、科目×メジャー単位で管理**
   - `AffiliatedMajor`テーブルに`course_category_id`を持たせる

2. **教室は複数指定可能**
   - 中間テーブル`CourseClassroom`で管理

3. **時間割コードは科目の一意キー**
   - 重複する時間割コードは存在しない

---

## トラブルシューティング

### よくある問題

#### 1. 情報応用科目が正しく判定されない

**原因:** 科目名に「情報応用」という文字列が含まれていない

**解決策:**
- CSVデータの科目名を確認
- 必要に応じて`csv_extractor.py`の判定ロジックを調整

#### 2. 履修区分が表示されない

**原因:**
- `course_category_id`が取得できていない
- メジャーと科目の関連付けが正しくない

**解決策:**
- `affiliated_major`テーブルを確認
- `get_course_category_id()`関数のデバッグ

#### 3. 時間割の重複判定が正しく動作しない

**原因:** 開講区分の重複判定ロジックが正しくない

**解決策:**
- `offeringCategoriesOverlap()`関数を確認
- コンソールログでデバッグ

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-12 | 初版作成 |

---

## 参考ファイル

- `setup/csv_extractor.py` - CSVデータ抽出
- `setup/insert_csv_data.py` - データベース投入
- `src/views/main.py` - ビューロジック
- `src/models.py` - データモデル定義
- `src/templates/result.html` - 時間割表示テンプレート
