{% extends "base.html" %}

{% block title %}{{ t('result', 'title') }} - {{ super() }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <div class="text-center mb-8">
        <div class="flex items-center justify-center gap-4 mb-2">
            <h1 class="text-4xl font-bold">{{ t('result', 'title') }}</h1>
            {% if fiscal_year %}
            <span class="text-xl text-base-content/80">{{ fiscal_year }}</span>
            {% endif %}
        </div>
    </div>

    <div class="collapse collapse-arrow bg-base-100 shadow-xl mb-6">
        <input type="checkbox" checked />
        <div class="collapse-title text-xl font-medium">
            {{ t('result', 'selected_conditions') }}
        </div>
        <div class="collapse-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-4">
                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-title">{{ t('index', 'semester') }}</div>
                        <div class="stat-value text-2xl text-accent">{{ semester_name }}</div>
                    </div>
                </div>

                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-title">{{ t('index', 'major1') }}</div>
                        <div class="stat-value text-2xl text-primary">{{ major1_name }}</div>
                    </div>
                </div>

                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-title">{{ t('index', 'major2') }}</div>
                        <div class="stat-value text-2xl text-secondary">{{ major2_name }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
            <h2 class="card-title text-2xl mb-4">{{ t('result', 'timetable') }}</h2>

            {% if semester % 2 == 1 %}
                {% set quarter1 = 1 %}
                {% set quarter2 = 2 %}
            {% else %}
                {% set quarter1 = 3 %}
                {% set quarter2 = 4 %}
            {% endif %}

            {# クォーターの情報をリスト化し、ループ処理で重複を削減 #}
            {% set quarters = [
                {'id': quarter1, 'checked': true},
                {'id': quarter2, 'checked': false}
            ] %}

            <div role="tablist" class="tabs tabs-border tabs-lg justify-center">
                {% for q in quarters %}
                {% set current_quarter = q.id %}
                <input type="radio" name="quarter_tabs" role="tab" class="tab" aria-label="{{ t('result', 'quarter_' ~ current_quarter) }}" {% if q.checked %}checked{% endif %} />
                <div role="tabpanel" class="tab-content pt-4">
                    <div class="overflow-x-auto">
                        <table class="table w-full">
                            <thead>
                                <tr class="bg-base-200">
                                    <th class="text-center w-5 font-normal border border-base-300 px-0  py-1"></th>
                                    <th class="text-center w-1/5 font-normal border border-base-300 px-2  py-1 min-w-30">{{ t('result', 'monday') }}</th>
                                    <th class="text-center w-1/5 font-normal border border-base-300 px-2  py-1 min-w-30">{{ t('result', 'tuesday') }}</th>
                                    <th class="text-center w-1/5 font-normal border border-base-300 px-2  py-1 min-w-30">{{ t('result', 'wednesday') }}</th>
                                    <th class="text-center w-1/5 font-normal border border-base-300 px-2  py-1 min-w-30">{{ t('result', 'thursday') }}</th>
                                    <th class="text-center w-1/5 font-normal border border-base-300 px-2  py-1 min-w-30">{{ t('result', 'friday') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for period in range(1, max_period + 1) %}
                                <tr class="hover h-20">
                                    <td class="text-center w-5 bg-base-200 border border-base-300 px-1">{{ period }}</td>
                                    {% for day_id in range(1, 6) %}
                                    <td class="border border-base-300 px-2 py-2 h-28">
                                    {% set courses_in_slot = [] %}
                                    {% for item in timetable[day_id].get(period, []) %}
                                        {# クォーターID (current_quarter) を使用してフィルタリングを共通化 #}
                                        {% if item['offering_category_id'] == current_quarter or (current_quarter in [1, 2] and item['offering_category_id'] == 5) or (current_quarter in [3, 4] and item['offering_category_id'] == 6) %}
                                            {% set _ = courses_in_slot.append(item) %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if courses_in_slot %}
                                        {% for item in courses_in_slot %}
                                        <div class="course-item text-sm p-1 rounded {% if not loop.first %}mt-2 pt-2 border-t border-base-300{% endif %} transition-all duration-200"
                                             data-day="{{ day_id }}"
                                             data-period="{{ period }}"
                                             data-index="{{ loop.index0 }}"
                                             data-offering-category="{{ item['offering_category_id'] }}"
                                             data-course-title="{{ item['course_title'] }}"
                                             data-instructor="{{ item['instructor_name'] }}"
                                             data-course-id="course-{{ day_id }}-{{ period }}-{{ loop.index0 }}">
                                            {% set major_type = item['major_type'] %}
                                            {% set offering_category = item['offering_category_id'] %}

                                            {% set indicator = '' %}
                                            {% set color_class = 'text-base-content' %}

                                            {# 開講区分のタグ設定 #}
                                            {% set offering_tag = '' %}
                                            {% if offering_category == 1 %}
                                                {% set offering_tag = t('result', 'quarter_1') %}
                                            {% elif offering_category == 2 %}
                                                {% set offering_tag = t('result', 'quarter_2') %}
                                            {% elif offering_category == 3 %}
                                                {% set offering_tag = t('result', 'quarter_3') %}
                                            {% elif offering_category == 4 %}
                                                {% set offering_tag = t('result', 'quarter_4') %}
                                            {% elif offering_category == 5 %}
                                                {% set offering_tag = t('result', 'semester_first') %}
                                            {% elif offering_category == 6 %}
                                                {% set offering_tag = t('result', 'semester_second') %}
                                            {% endif %}

                                            {% if major_type == 'major1' %}
                                                {% set indicator = '【' + t('result', 'label_major1') + '】' %}
                                                {% set color_class = 'text-primary' %}
                                            {% elif major_type == 'shared' %}
                                                {% set indicator = '【' + t('result', 'label_shared') + '】' %}
                                                {% set color_class = 'text-primary' %}
                                            {% elif major_type == 'major2' %}
                                                {% set indicator = '【' + t('result', 'label_major2') + '】' %}
                                                {% set color_class = 'text-secondary' %}
                                            {% elif major_type == 'others' %}
                                                {% set indicator = '【' + t('result', 'label_others') + '】' %}
                                                {% set color_class = 'text-info' %}
                                            {% elif major_type == 'info_app' %}
                                                {% set indicator = '【' + t('result', 'label_info_app') + '】' %}
                                                {% set color_class = 'text-warning' %}
                                            {% endif %}

                                            <div class="course-content cursor-pointer hover:bg-base-200 rounded p-1"
                                                 onclick="showCourseDetails(
                                                     '{{ item['timetable_code'] }}',
                                                     '{{ item['course_title'] }}',
                                                     '{{ item['instructor_name'] }}',
                                                     {{ item['credits'] }},
                                                     {{ item['offering_category_id'] }},
                                                     '{{ item['major_type'] }}',
                                                     {{ day_id }},
                                                     {{ period }},
                                                     '{{ item['classroom_name'] }}',
                                                     '{{ item['syllabus_url'] }}'
                                                 )">
                                                <div class="font-semibold {{ color_class }} flex items-center gap-1 flex-wrap justify-between">
                                                    <span>{{ indicator }}</span>
                                                    {% if offering_tag %}
                                                    <span class="badge badge-sm badge-soft">{{ offering_tag }}</span>
                                                    {% endif %}
                                                </div>
                                                <div class="mt-1">{{ item['course_title'] }}</div>
                                                {% if item['instructor_name'] %}
                                                <div class="text-xs text-base-content/90 mt-1">{{ item['instructor_name'] }}</div>
                                                {% endif %}
                                                {# 科目名の下に情報アイコンを追加してクリック可能であることを示す #}
                                                <div class="font-semibold {{ course_color_class }} mt-1 flex items-center justify-end">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                        {% else %}
                                        <div class="text-center text-base-content/60">-</div>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
            </div>

            {# 集中講義・実験実習セクション #}
            {% if intensive_courses %}
            <div class="mt-6">
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body p-4">
                        <h3 class="font-semibold text-lg mb-3">{{ t('result', 'intensive_courses') }}</h3>
                        <p class="text-sm text-base-content/90 mb-4">{{ t('result', 'intensive_courses_note') }}</p>

                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            {% for item in intensive_courses %}
                            <div class="border border-base-300 px-2 py-2 min-h-28">
                                <div class="course-item text-sm p-1 rounded transition-all duration-200">
                                    {% set major_type = item['major_type'] %}
                                    {% set offering_category = item['offering_category_id'] %}

                                    {% set indicator = '' %}
                                    {% set color_class = 'text-base-content' %}

                                    {# 開講区分のタグ設定 #}
                                    {% set offering_tag = '' %}
                                    {% if offering_category == 1 %}
                                        {% set offering_tag = t('result', 'quarter_1') %}
                                    {% elif offering_category == 2 %}
                                        {% set offering_tag = t('result', 'quarter_2') %}
                                    {% elif offering_category == 3 %}
                                        {% set offering_tag = t('result', 'quarter_3') %}
                                    {% elif offering_category == 4 %}
                                        {% set offering_tag = t('result', 'quarter_4') %}
                                    {% elif offering_category == 5 %}
                                        {% set offering_tag = t('result', 'semester_first') %}
                                    {% elif offering_category == 6 %}
                                        {% set offering_tag = t('result', 'semester_second') %}
                                    {% endif %}

                                    {% if major_type == 'major1' %}
                                        {% set indicator = '【' + t('result', 'label_major1') + '】' %}
                                        {% set color_class = 'text-primary' %}
                                    {% elif major_type == 'shared' %}
                                        {% set indicator = '【' + t('result', 'label_shared') + '】' %}
                                        {% set color_class = 'text-primary' %}
                                    {% elif major_type == 'major2' %}
                                        {% set indicator = '【' + t('result', 'label_major2') + '】' %}
                                        {% set color_class = 'text-secondary' %}
                                    {% elif major_type == 'others' %}
                                        {% set indicator = '【' + t('result', 'label_others') + '】' %}
                                        {% set color_class = 'text-info' %}
                                    {% elif major_type == 'info_app' %}
                                        {% set indicator = '【' + t('result', 'label_info_app') + '】' %}
                                        {% set color_class = 'text-warning' %}
                                    {% endif %}

                                    <div class="course-content cursor-pointer hover:bg-base-200 rounded p-1"
                                         onclick="showCourseDetails(
                                             '{{ item['timetable_code'] }}',
                                             '{{ item['course_title'] }}',
                                             '{{ item['instructor_name'] }}',
                                             {{ item['credits'] }},
                                             {{ item['offering_category_id'] }},
                                             '{{ item['major_type'] }}',
                                             0,
                                             0,
                                             '{{ item['classroom_name'] }}',
                                             '{{ item['syllabus_url'] }}'
                                         )">
                                        <div class="font-semibold {{ color_class }} flex items-center gap-1 flex-wrap justify-between">
                                            <span>{{ indicator }}</span>
                                            {% if offering_tag %}
                                            <span class="badge badge-sm badge-soft">{{ offering_tag }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="mt-1">{{ item['course_title'] }}</div>
                                        {% if item['instructor_name'] %}
                                        <div class="text-xs text-base-content/90 mt-1">{{ item['instructor_name'] }}</div>
                                        {% endif %}
                                        {# 科目名の下に情報アイコンを追加してクリック可能であることを示す #}
                                        <div class="font-semibold mt-1 flex items-center justify-end">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="mt-6">
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body p-4">
                        <h3 class="font-semibold text-lg mb-3">{{ t('result', 'credit_info') }}</h3>

                        {# 単位情報をリスト化し、ループ処理で重複を削減 #}
                        {% set credit_types = [
                            {'title_key': 'shared_courses', 'credits': shared_credits, 'color': 'primary'},
                            {'title_key': 'major1_courses', 'credits': major1_credits, 'color': 'primary'},
                            {'title_key': 'major2_courses', 'credits': major2_credits, 'color': 'secondary'},
                            {'title_key': 'others_courses', 'credits': others_credits, 'color': 'info'},
                            {'title_key': 'info_app_courses', 'credits': info_app_credits, 'color': 'warning'}
                        ] %}

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            {% for type in credit_types %}
                                {% set credits = type.credits %}
                                {% if (credits['required'] + credits['elective']) >= 1 %}
                                <div>
                                    <div class="text-sm font-medium text-{{ type.color }} mb-2">{{ t('result', type.title_key) }}</div>
                                    <div class="stats shadow w-full">
                                        <div class="stat py-2 px-3">
                                            <div class="stat-title text-xs">{{ t('result', 'required_mandatory') }}</div>
                                            <div class="stat-value text-xl">{{ credits['required'] }}</div>
                                        </div>
                                        <div class="stat py-2 px-3">
                                            <div class="stat-title text-xs">{{ t('result', 'elective_required_elective') }}</div>
                                            <div class="stat-value text-xl">{{ credits['elective'] }}</div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>

                        <div class="mt-6 flex justify-center">
                            <div class="w-full max-w-xs">
                                <div class="stats shadow w-full bg-accent/10">
                                    <div class="stat py-3 px-4">
                                        <div class="stat-title text-sm font-semibold">{{ t('result', 'total_simple') }}</div>
                                        <div class="stat-value text-3xl text-accent">{{ total_credits }}</div>
                                        <div class="stat-desc text-sm font-medium">{{ t('result', 'credits') }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="flex justify-center gap-4 mb-8">
        <a href="{{ url_for('index') }}" class="btn btn-outline btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            {{ t('result', 'back') }}
        </a>
    </div>
</div>


<!-- 科目詳細モーダル -->
<dialog id="course_modal" class="modal">
    <div class="modal-box max-w-3xl">
        <h3 class="font-bold text-xl mb-2 text-base-content/80">{{ t('result', 'course_details') }}</h3>

        <!-- 科目名 -->
        <div class="mb-6 pb-4 border-b border-base-300">
            <p id="modal_course_title" class="text-2xl font-bold text-base-content"></p>
        </div>

        <!-- その他の情報 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-6">
            <!-- 時間割コード -->
            <div>
                <div class="text-xs font-semibold text-base-content/70 mb-1.5 uppercase tracking-wide">{{ t('result', 'timetable_code') }}</div>
                <p id="modal_timetable_code" class="text-base font-medium text-base-content font-mono"></p>
            </div>

            <!-- 担当教員 -->
            <div>
                <div class="text-xs font-semibold text-base-content/70 mb-1.5 uppercase tracking-wide">{{ t('result', 'instructor') }}</div>
                <p id="modal_instructor" class="text-base font-medium text-base-content"></p>
            </div>

            <!-- 単位数 -->
            <div>
                <div class="text-xs font-semibold text-base-content/70 mb-1.5 uppercase tracking-wide">{{ t('result', 'credits_label') }}</div>
                <p id="modal_credits" class="text-base font-medium text-base-content"></p>
            </div>

            <!-- 開講区分 -->
            <div>
                <div class="text-xs font-semibold text-base-content/70 mb-1.5 uppercase tracking-wide">{{ t('result', 'offering_period') }}</div>
                <p id="modal_offering" class="text-base font-medium text-base-content"></p>
            </div>

            <!-- メジャー区分 -->
            <div>
                <div class="text-xs font-semibold text-base-content/70 mb-1.5 uppercase tracking-wide">{{ t('result', 'major_category') }}</div>
                <p id="modal_major_type" class="text-base font-medium text-base-content"></p>
            </div>

            <!-- 曜日・時限 -->
            <div>
                <div class="text-xs font-semibold text-base-content/70 mb-1.5 uppercase tracking-wide">{{ t('result', 'day_period') }}</div>
                <p id="modal_schedule" class="text-base font-medium text-base-content"></p>
            </div>

            <!-- 教室 -->
            <div>
                <div class="text-xs font-semibold text-base-content/70 mb-1.5 uppercase tracking-wide">{{ t('result', 'classroom') }}</div>
                <p id="modal_classroom" class="text-base font-medium text-base-content"></p>
            </div>

            <!-- シラバスリンク -->
            <div class="md:col-span-2 pt-2">
                <div class="text-xs font-semibold text-base-content/70 mb-2 uppercase tracking-wide">{{ t('result', 'syllabus_link') }}</div>
                <div id="modal_syllabus_container"></div>
            </div>
        </div>

        <div class="modal-action mt-6">
            <form method="dialog">
                <button class="btn btn-neutral">{{ t('result', 'close') }}</button>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- 翻訳データとJavaScript -->
<script>
// 翻訳データをJavaScriptに渡す
window.translations = {
    days: {
        1: "{{ t('result', 'monday') }}",
        2: "{{ t('result', 'tuesday') }}",
        3: "{{ t('result', 'wednesday') }}",
        4: "{{ t('result', 'thursday') }}",
        5: "{{ t('result', 'friday') }}"
    },
    offerings: {
        1: "{{ t('result', 'quarter_1') }}",
        2: "{{ t('result', 'quarter_2') }}",
        3: "{{ t('result', 'quarter_3') }}",
        4: "{{ t('result', 'quarter_4') }}",
        5: "{{ t('result', 'semester_first') }}",
        6: "{{ t('result', 'semester_second') }}"
    },
    majors: {
        'major1': "{{ t('result', 'major1_courses') }}",
        'major2': "{{ t('result', 'major2_courses') }}",
        'shared': "{{ t('result', 'shared_courses') }}",
        'others': "{{ t('result', 'others_courses') }}",
        'info_app': "{{ t('result', 'info_app_courses') }}"
    },
    credits: "{{ t('result', 'credit_unit_badge') }}",
    openSyllabus: "{{ t('result', 'open_syllabus') }}"
};

/**
 * 科目詳細をモーダルで表示する
 * @param {string} timetableCode - 時間割コード
 * @param {string} title - 科目名
 * @param {string} instructor - 担当教員名
 * @param {number} credits - 単位数
 * @param {number} offeringCategory - 開講区分ID
 * @param {string} majorType - メジャータイプ
 * @param {number} dayId - 曜日ID (1-5)
 * @param {number} period - 時限 (1-5)
 * @param {string} classroom - 教室名
 * @param {string} syllabusUrl - シラバスURL
 */
function showCourseDetails(timetableCode, title, instructor, credits, offeringCategory, majorType, dayId, period, classroom, syllabusUrl) {
    // モーダルに情報を設定
    document.getElementById('modal_timetable_code').textContent = timetableCode || '-';
    document.getElementById('modal_course_title').textContent = title;
    document.getElementById('modal_instructor').textContent = instructor || '-';
    document.getElementById('modal_credits').textContent = credits + window.translations.credits;
    document.getElementById('modal_offering').textContent = window.translations.offerings[offeringCategory] || '-';
    document.getElementById('modal_major_type').textContent = window.translations.majors[majorType] || '-';

    // 曜日・時限（集中講義の場合は「-」を表示）
    if (dayId > 0 && period > 0) {
        document.getElementById('modal_schedule').textContent = window.translations.days[dayId] + ' ' + period + '限';
    } else {
        document.getElementById('modal_schedule').textContent = '-';
    }

    document.getElementById('modal_classroom').textContent = classroom || '-';

    // シラバスリンクを設定
    const syllabusContainer = document.getElementById('modal_syllabus_container');
    if (syllabusUrl && syllabusUrl.trim() !== '') {
        syllabusContainer.innerHTML = `
            <a href="${syllabusUrl}" target="_blank" rel="noopener noreferrer" class="btn btn-primary btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
                ${window.translations.openSyllabus}
            </a>
        `;
    } else {
        syllabusContainer.innerHTML = '<p class="text-base">-</p>';
    }

    // モーダルを表示
    document.getElementById('course_modal').showModal();
}
</script>
{% endblock %}