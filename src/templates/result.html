{% extends "base.html" %}

{% block title %}{{ t('result', 'title') }} - {{ super() }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <div class="text-center mb-8">
        <div class="flex items-center justify-center gap-4 mb-2">
            <h1 class="text-4xl font-bold">{{ t('result', 'title') }}</h1>
            {% if fiscal_year %}
            <span class="text-xl text-base-content/60">{{ fiscal_year }}</span>
            {% endif %}
        </div>
    </div>

    <div class="collapse collapse-arrow bg-base-100 shadow-xl mb-6">
        <input type="checkbox" checked />
        <div class="collapse-title text-xl font-medium">
            {{ t('result', 'selected_conditions') }}
        </div>
        <div class="collapse-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-4">
                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-title">{{ t('index', 'semester') }}</div>
                        <div class="stat-value text-2xl text-accent">{{ semester_name }}</div>
                    </div>
                </div>

                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-title">{{ t('index', 'major1') }}</div>
                        <div class="stat-value text-2xl text-primary">{{ major1_name }}</div>
                    </div>
                </div>

                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-title">{{ t('index', 'major2') }}</div>
                        <div class="stat-value text-2xl text-secondary">{{ major2_name }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
            <h2 class="card-title text-2xl mb-4">{{ t('result', 'timetable') }}</h2>

            {% if semester % 2 == 1 %}
                {% set quarter1 = 1 %}
                {% set quarter2 = 2 %}
            {% else %}
                {% set quarter1 = 3 %}
                {% set quarter2 = 4 %}
            {% endif %}

            {# クォーターの情報をリスト化し、ループ処理で重複を削減 #}
            {% set quarters = [
                {'id': quarter1, 'checked': true},
                {'id': quarter2, 'checked': false}
            ] %}

            <div role="tablist" class="tabs tabs-boxed mt-4 justify-center">
                {% for q in quarters %}
                {% set current_quarter = q.id %}
                <input type="radio" name="quarter_tabs" role="tab" class="tab" aria-label="{{ t('result', 'quarter_' ~ current_quarter) }}" {% if q.checked %}checked{% endif %} />
                <div role="tabpanel" class="tab-content pt-4">
                    <div class="overflow-x-auto">
                        <table class="table w-full">
                            <thead>
                                <tr class="bg-base-200">
                                    <th class="text-center w-5 font-normal border border-base-300 px-0  py-1"></th>
                                    <th class="text-center w-1/5 font-normal border border-base-300 px-2  py-1 min-w-40">{{ t('result', 'monday') }}</th>
                                    <th class="text-center w-1/5 font-normal border border-base-300 px-2  py-1 min-w-40">{{ t('result', 'tuesday') }}</th>
                                    <th class="text-center w-1/5 font-normal border border-base-300 px-2  py-1 min-w-40">{{ t('result', 'wednesday') }}</th>
                                    <th class="text-center w-1/5 font-normal border border-base-300 px-2  py-1 min-w-40">{{ t('result', 'thursday') }}</th>
                                    <th class="text-center w-1/5 font-normal border border-base-300 px-2  py-1 min-w-40">{{ t('result', 'friday') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for period in range(1, 6) %}
                                <tr class="hover h-20">
                                    <td class="text-center w-5 bg-base-200 border border-base-300 px-1">{{ period }}</td>
                                    {% for day_id in range(1, 6) %}
                                    <td class="border border-base-300 px-2 py-2">
                                    {% set courses_in_slot = [] %}
                                    {% for item in timetable[day_id].get(period, []) %}
                                        {# クォーターID (current_quarter) を使用してフィルタリングを共通化 #}
                                        {% if item['offering_category_id'] == current_quarter or (current_quarter in [1, 2] and item['offering_category_id'] == 5) or (current_quarter in [3, 4] and item['offering_category_id'] == 6) %}
                                            {% set _ = courses_in_slot.append(item) %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if courses_in_slot %}
                                        {% for item in courses_in_slot %}
                                        <div class="text-sm {% if not loop.first %}mt-2 pt-2 border-t border-base-300{% endif %}">
                                            {% set major_type = item['major_type'] %}

                                            {% set indicator = '' %}
                                            {% set color_class = 'text-base-content' %}

                                            {% if major_type == 'major1' %}
                                                {% set indicator = '【' + t('result', 'label_major1') + '】' %}
                                                {% set color_class = 'text-primary' %}
                                            {% elif major_type == 'shared' %}
                                                {% set indicator = '【' + t('result', 'label_shared') + '】' %}
                                                {% set color_class = 'text-primary' %}
                                            {% elif major_type == 'major2' %}
                                                {% set indicator = '【' + t('result', 'label_major2') + '】' %}
                                                {% set color_class = 'text-secondary' %}
                                            {% elif major_type == 'others' %}
                                                {% set indicator = '【' + t('result', 'label_others') + '】' %}
                                                {% set color_class = 'text-info' %}
                                            {% elif major_type == 'info_app' %}
                                                {% set indicator = '【' + t('result', 'label_info_app') + '】' %}
                                                {% set color_class = 'text-warning' %}
                                            {% endif %}

                                            <div class="font-semibold {{ color_class }}">
                                                {{ indicator }}<br>{{ item['course_title'] }}
                                            </div>
                                            {% if item['instructor_name'] %}
                                            <div class="text-xs text-base-content/70">{{ item['instructor_name'] }}</div>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                        {% else %}
                                        <div class="text-center text-base-content/40">-</div>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="mt-6">
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body p-4">
                        <h3 class="font-semibold text-lg mb-3">{{ t('result', 'credit_info') }}</h3>

                        {# 単位情報をリスト化し、ループ処理で重複を削減 #}
                        {% set credit_types = [
                            {'title_key': 'shared_courses', 'credits': shared_credits, 'color': 'primary'},
                            {'title_key': 'major1_courses', 'credits': major1_credits, 'color': 'primary'},
                            {'title_key': 'major2_courses', 'credits': major2_credits, 'color': 'secondary'},
                            {'title_key': 'others_courses', 'credits': others_credits, 'color': 'info'},
                            {'title_key': 'info_app_courses', 'credits': info_app_credits, 'color': 'warning'}
                        ] %}

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            {% for type in credit_types %}
                                {% set credits = type.credits %}
                                {% if (credits['required'] + credits['elective']) >= 1 %}
                                <div>
                                    <div class="text-sm font-medium text-{{ type.color }} mb-2">{{ t('result', type.title_key) }}</div>
                                    <div class="stats shadow w-full">
                                        <div class="stat py-2 px-3">
                                            <div class="stat-title text-xs">{{ t('result', 'required_mandatory') }}</div>
                                            <div class="stat-value text-xl">{{ credits['required'] }}</div>
                                        </div>
                                        <div class="stat py-2 px-3">
                                            <div class="stat-title text-xs">{{ t('result', 'elective_required_elective') }}</div>
                                            <div class="stat-value text-xl">{{ credits['elective'] }}</div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>

                        <div class="mt-6 flex justify-center">
                            <div class="w-full max-w-xs">
                                <div class="stats shadow w-full bg-accent/10">
                                    <div class="stat py-3 px-4">
                                        <div class="stat-title text-sm font-semibold">{{ t('result', 'total_simple') }}</div>
                                        <div class="stat-value text-3xl text-accent">{{ total_credits }}</div>
                                        <div class="stat-desc text-sm font-medium">{{ t('result', 'credits') }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="flex justify-center gap-4 mb-8">
        <a href="{{ url_for('index') }}" class="btn btn-outline btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            {{ t('result', 'back') }}
        </a>

        <button class="btn btn-primary" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            {{ t('result', 'download') }}
        </button>
    </div>
</div>
{% endblock %}